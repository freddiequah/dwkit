#!/bin/sh
echo "[HOOK] pre-commit running..." 1>&2

branch="$(git rev-parse --abbrev-ref HEAD)"
if [ "$branch" = "main" ]; then
  echo "ERROR: Direct commits to main are blocked. Create a branch first." 1>&2
  echo "Use: git checkout -b <topic/name>" 1>&2
  exit 1
fi

# Block UTF-8 BOM in docs/*.md
fail=0
for f in $(git ls-files "docs/*.md"); do
  sig=$(head -c 3 "$f" 2>/dev/null | od -An -t x1 | tr -d ' \n')
  if [ "$sig" = "efbbbf" ]; then
    echo "ERROR: UTF-8 BOM detected in $f (EF BB BF). Save as UTF-8 (no BOM) and retry." 1>&2
    fail=1
  fi
done

if [ "$fail" -ne 0 ]; then
  exit 1
fi

exit 0
